<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¹ã‚±åŠ©</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body, html { margin: 0; padding: 0; height: 100%; font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; overflow: hidden; }
        #app-container { display: flex; flex-direction: column; height: 100vh; }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        #app-header {
            background: #fff; padding: 0 15px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); height: 50px; box-sizing: border-box; z-index: 10;
        }
        .header-left { font-weight: bold; font-size: 1.1em; color: #4285f4; display: flex; align-items: center; }
        .header-right { display: flex; align-items: center; font-size: 0.9em; color: #555; }
        .settings-icon { font-size: 1.4em; margin-right: 10px; cursor: pointer; color: #777; }

        /* --- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¨ãƒªã‚¢ --- */
        #timeline-area {
            flex: 1; /* ç”»é¢ã®1/3 */
            background: #fff; border-bottom: 2px solid #ddd; overflow: auto;
            display: grid; grid-template-columns: 80px repeat(auto-fill, minmax(80px, 1fr)); grid-auto-rows: minmax(50px, auto);
        }
        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è£…é£¾ */
        .category-label { position: sticky; left: 0; background: #f8f9fa; z-index: 5; border-right: 2px solid #eee; border-bottom: 1px solid #eee; display: flex; align-items: center; padding: 0 5px; font-weight: bold; color: #555; font-size: 0.75em; }
        .date-header { position: sticky; top: 0; background: #fff; z-index: 4; text-align: center; padding: 4px; border-bottom: 2px solid #eee; border-right: 1px solid #eee; font-weight: bold; color: #555; font-size: 0.75em; }
        .timeline-cell { border-right: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; padding: 2px; vertical-align: top; }
        .timeline-event-card { padding: 3px 4px; margin-bottom: 2px; border-radius: 3px; font-size: 0.7em; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-left-width: 4px; border-left-style: solid; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¨ãƒªã‚¢ --- */
        #calendar-area {
            flex: 2; /* ç”»é¢ã®2/3 */
            padding: 5px; background: #fff; overflow: hidden;
            position: relative;
        }
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        #calendar { height: 100%; font-size: 0.85em; }

        /* â˜…é‡è¦ï¼šæ—¥ä»˜ãƒã‚¹ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨­å®š */
        .fc-daygrid-day-frame {
            display: flex; flex-direction: column; overflow: hidden; /* ãƒã‚¹ã‹ã‚‰ã¯ã¿å‡ºã•ã›ãªã„ */
        }
        .fc-daygrid-day-top {
            flex-shrink: 0; /* æ—¥ä»˜æ•°å­—ã¯ç¸®ã‚ãªã„ */
        }
        .fc-daygrid-day-events {
            flex-grow: 1;
            overflow-y: auto !important; /* â˜…ä¸­èº«ãŒå¤šã„æ™‚ã¯ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            padding-bottom: 2px;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ç´°ãç›®ç«‹ãŸãªã */
            scrollbar-width: thin; 
        }
        .fc-daygrid-day-events::-webkit-scrollbar { width: 3px; background: transparent; }
        .fc-daygrid-day-events::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

        /* æ—¥ä»˜æ•°å­—ã‚’ã¯ã£ãã‚Šè¡¨ç¤º */
        .fc-daygrid-day-number {
            font-size: 1.1em; font-weight: bold; color: #333; margin-right: 4px;
        }
        /* åœŸæ—¥ã®è‰² */
        .fc-day-sat .fc-daygrid-day-number { color: #3366cc; }
        .fc-day-sun .fc-daygrid-day-number { color: #dc3912; }

        /* ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º */
        .fc-event-title { white-space: normal !important; font-size: 0.8em; line-height: 1.1; }
        .fc-toolbar-title { font-size: 1.1em !important; font-weight: bold; }
        .fc .fc-button { padding: 4px 8px; font-size: 0.85em; }

        /* æ è‰² */
        .border-gold  { border: 3px solid #d4af37 !important; background-color: #fffbf0; }
        .border-red   { border: 2px solid #ff4d4d !important; }
        .border-blue  { border: 2px solid #4d79ff !important; }
        .border-green { border: 2px solid #2eb82e !important; }

        /* FABãƒœã‚¿ãƒ³ */
        .fab-container { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 100; }
        .fab-btn { width: 52px; height: 52px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); cursor: pointer; color: white; transition: transform 0.1s; }
        .fab-btn:active { transform: scale(0.95); }
        #camera-btn { background-color: #4285f4; }
        #chat-btn { background-color: #34a853; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 90%; max-width: 380px; border-radius: 12px; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; max-height: 80vh; }
        
        /* ãƒãƒ£ãƒƒãƒˆ */
        #chat-history { flex: 1; overflow-y: auto; margin-bottom: 10px; border: 1px solid #eee; border-radius: 8px; padding: 10px; background: #f9f9f9; min-height: 200px; }
        .chat-msg { margin-bottom: 8px; padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 0.9em; }
        .msg-user { background: #e3f2fd; align-self: flex-end; margin-left: auto; }
        .msg-ai { background: #fff; border: 1px solid #ddd; align-self: flex-start; margin-right: auto; }
        .chat-input-area { display: flex; gap: 5px; }
        #chat-input-text { flex: 1; padding: 8px; border-radius: 20px; border: 1px solid #ccc; font-size: 16px; }

        /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
        #preview-image { width: 100%; max-height: 180px; object-fit: contain; margin-bottom: 10px; border: 1px solid #eee; }
        #prompt-input { width: 100%; height: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; resize: none; font-size: 14px; }

        /* ãƒœã‚¿ãƒ³ */
        .btn { padding: 10px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; flex: 1; margin: 0 5px; font-size: 0.9em; }
        .btn-cancel { background: #eee; color: #555; }
        .btn-submit { background: #4285f4; color: white; }

        /* è¨­å®šç”»é¢ãƒªã‚¹ãƒˆ */
        .settings-list { list-style: none; padding: 0; margin: 0; }
        .settings-list li { padding: 15px 0; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; color: #333; }
        .settings-list li:last-child { border-bottom: none; }
        .arrow { color: #ccc; }

        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); color: #4285f4; z-index: 3000; justify-content: center; align-items: center; flex-direction: column; font-weight: bold; }
    </style>
</head>
<body>

<div id="app-container">
    <header id="app-header">
        <div class="header-left">ğŸ¤– ã‚¹ã‚±åŠ©</div>
        <div class="header-right">
            <span class="settings-icon" onclick="openModal('settings-modal')">âš™ï¸</span>
            <span id="user-info">è¥¿æ‘å“² ã•ã‚“</span>
        </div>
    </header>

    <div id="timeline-area"><div style="padding:20px; grid-column:1/-1; color:#888;">èª­ã¿è¾¼ã¿ä¸­...</div></div>
    <div id="calendar-area"><div id='calendar'></div></div>
</div>

<div class="fab-container">
    <div id="chat-btn" class="fab-btn" onclick="openModal('chat-modal')">ğŸ’¬</div>
    <div id="camera-btn" class="fab-btn" onclick="document.getElementById('file-input').click()">ğŸ“·</div>
</div>
<input type="file" id="file-input" accept="image/*" style="display: none;" onchange="openUploadModal(this)">

<div id="upload-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="font-weight:bold; margin-bottom:10px;">AIã¸ã®æŒ‡ç¤º</div>
        <img id="preview-image" src="">
        <textarea id="prompt-input" placeholder="ä¾‹ï¼šã‚µãƒƒã‚«ãƒ¼ã®äºˆå®šã ã‘å…¥ã‚Œã¦"></textarea>
        <div style="display: flex;">
            <button class="btn btn-cancel" onclick="closeModal('upload-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-submit" onclick="submitImageWithPrompt()">é€ä¿¡</button>
        </div>
    </div>
</div>

<div id="chat-modal" class="modal-overlay">
    <div class="modal-content" style="height: 70vh;">
        <div style="font-weight:bold; margin-bottom:10px; display:flex; justify-content:space-between;">
            <span>AIãƒãƒ£ãƒƒãƒˆ</span><span onclick="closeModal('chat-modal')" style="cursor:pointer;">âœ•</span>
        </div>
        <div id="chat-history"><div class="chat-msg msg-ai">ã“ã‚“ã«ã¡ã¯ï¼äºˆå®šã®ã“ã¨ãªã‚‰ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã€‚</div></div>
        <div class="chat-input-area">
            <input type="text" id="chat-input-text" placeholder="è³ªå•ã‚’å…¥åŠ›...">
            <button class="fab-btn" style="width:40px; height:40px; font-size:16px; background:#4285f4; margin:0;" onclick="sendChatMessage()">â¤</button>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="font-weight:bold; margin-bottom:10px; font-size:1.2em;">è¨­å®š</div>
        <ul class="settings-list">
            <li onclick="alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šæ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™')">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç·¨é›† <span class="arrow">â€º</span></li>
            <li onclick="alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®šæ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™')">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºè¨­å®š <span class="arrow">â€º</span></li>
            <li onclick="alert('ã‚«ãƒ†ã‚´ãƒªè¨­å®šæ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™')">ã‚«ãƒ†ã‚´ãƒªãƒ¼è‰²ç·¨é›† <span class="arrow">â€º</span></li>
            <li onclick="alert('ãƒ˜ãƒ«ãƒ—æ©Ÿèƒ½ã¯ä»Šå¾Œå®Ÿè£…äºˆå®šã§ã™')">ãƒ˜ãƒ«ãƒ—ãƒ»ä½¿ã„æ–¹ <span class="arrow">â€º</span></li>
        </ul>
        <button class="btn btn-cancel" style="margin-top:20px;" onclick="closeModal('settings-modal')">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="loading-overlay"><div style="font-size: 2em; margin-bottom: 10px;">ğŸ¤–</div><div>å‡¦ç†ä¸­...</div></div>

<script>
    // â–¼ GASã®URLï¼ˆã‚ãªãŸã®URLï¼‰
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxS7p_2ekWJWMak9ivwKTbro11sD1QH9G2oVJOOMKpS9SKxaqJaxTf59FZvcC-_wsKg/exec";

    let allEvents = [];
    let calendar;
    let selectedFileBase64 = null; let selectedFileMimeType = null;
    const CATEGORIES = ['ä»•äº‹', 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ', 'å­ä¾›', 'ã‚µãƒƒã‚«ãƒ¼', 'ãã®ä»–'];

    document.addEventListener('DOMContentLoaded', function() { initCalendar(); fetchData(); });

    function initCalendar() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', locale: 'ja',
            height: '100%', // ç”»é¢ã„ã£ã±ã„ã«åºƒã’ã‚‹
            dayMaxEvents: false, // â˜…é‡è¦ï¼šå…¨ä»¶è¡¨ç¤ºï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ãŸã‚ï¼‰
            headerToolbar: { left: 'title', right: 'today prev,next' },
            dayCellContent: function(e) { e.dayNumberText = e.dayNumberText.replace('æ—¥', ''); },
            eventClick: function(info) { showEventDetail(info.event); },
            eventContent: function(arg) {
                let dotColor = getColorByCategory(arg.event.extendedProps.category);
                return { html: `<span style="color:${dotColor}; font-size:1.2em;">â—</span> ${arg.event.title}` };
            }
        });
        calendar.render();
    }

    function fetchData() { fetch(GAS_URL).then(r=>r.json()).then(d=>{ allEvents=d; updateCalendar(d); updateTimeline(d); }).catch(e=>console.error(e)); }
    function updateCalendar(d) { calendar.removeAllEvents(); calendar.addEventSource(d.map(i=>({title:i.title,start:i.start,end:i.end,extendedProps:{category:i.category,memo:i.memo}}))); }

    // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ›´æ–°ï¼ˆæ—¢å­˜ï¼‰
    function updateTimeline(data) {
        const container = document.getElementById('timeline-area'); container.innerHTML = "";
        if (data.length === 0) { container.innerHTML = '<div style="padding:20px; grid-column:1/-1;">äºˆå®šãªã—</div>'; return; }
        const eventsMap = {}; let minDate = new Date(); let maxDate = new Date();
        data.forEach(item => {
            const dateStr = new Date(item.start).toLocaleDateString(); const cat = normalizeCategory(item.category);
            if (!eventsMap[dateStr]) eventsMap[dateStr] = {}; if (!eventsMap[dateStr][cat]) eventsMap[dateStr][cat] = [];
            eventsMap[dateStr][cat].push(item); const itemDate = new Date(item.start); if (itemDate < minDate) minDate = itemDate; if (itemDate > maxDate) maxDate = itemDate;
        });
        minDate.setDate(minDate.getDate() - 2); maxDate.setDate(maxDate.getDate() + 14);
        const dateList = []; for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) dateList.push(new Date(d));
        container.style.gridTemplateColumns = `80px repeat(${dateList.length}, minmax(80px, 1fr))`;
        const corner = document.createElement('div'); corner.className = 'category-label'; corner.style.gridRow = '1'; corner.style.gridColumn = '1'; corner.innerHTML = 'ã‚«ãƒ†ã‚´ãƒªãƒ¼'; container.appendChild(corner);
        dateList.forEach((date, i) => {
            const header = document.createElement('div'); header.className = 'date-header'; header.style.gridRow = '1'; header.style.gridColumn = `${i + 2}`;
            header.innerHTML = `${date.getMonth()+1}/${date.getDate()}(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][date.getDay()]})`;
            if(date.getDay()===0) header.style.color='#dc3912'; if(date.getDay()===6) header.style.color='#3366cc'; container.appendChild(header);
        });
        CATEGORIES.forEach((cat, catIndex) => {
            const label = document.createElement('div'); label.className = 'category-label'; label.style.gridRow = `${catIndex + 2}`; label.style.gridColumn = '1'; label.style.borderLeft = `4px solid ${getColorByCategory(cat)}`; label.innerText = cat; container.appendChild(label);
            dateList.forEach((date, dateIndex) => {
                const cell = document.createElement('div'); cell.className = 'timeline-cell'; cell.style.gridRow = `${catIndex + 2}`; cell.style.gridColumn = `${dateIndex + 2}`;
                const dateStr = date.toLocaleDateString();
                if (eventsMap[dateStr] && eventsMap[dateStr][cat]) {
                    eventsMap[dateStr][cat].forEach(event => {
                        const card = document.createElement('div'); card.className = `timeline-event-card ${getBorderColorClass(event.start)}`; card.style.borderLeftColor = getColorByCategory(cat); card.innerHTML = event.title; 
                        card.onclick = function() { showEventDetail({ title: event.title, start: new Date(event.start), extendedProps: { category: event.category, memo: event.memo } }); };
                        cell.appendChild(card);
                    });
                } container.appendChild(cell);
            });
        });
        setTimeout(() => { const t=Array.from(container.querySelectorAll('.date-header')).find(h=>h.textContent.includes(`${new Date().getMonth()+1}/${new Date().getDate()}`)); if(t)t.scrollIntoView({inline:'center',block:'nearest'}); }, 500);
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†
    function showEventDetail(e) { alert(`ã€${e.title}ã€‘\næ—¥æ™‚: ${e.start.toLocaleString()}\nã‚«ãƒ†ã‚´ãƒªãƒ¼: ${e.extendedProps.category}\nãƒ¡ãƒ¢: ${e.extendedProps.memo}`); }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function sendChatMessage() {
        const input = document.getElementById('chat-input-text'); const text = input.value.trim(); if(!text) return;
        addChatBubble(text, 'user'); input.value = '';
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'chat', text: text }) })
        .then(r => r.json()).then(res => { addChatBubble(res.status==='success'?res.answer:"ã‚¨ãƒ©ãƒ¼", 'ai'); })
        .catch(e => { addChatBubble("é€šä¿¡ã‚¨ãƒ©ãƒ¼", 'ai'); });
    }
    function addChatBubble(text, sender) { const h = document.getElementById('chat-history'); const d = document.createElement('div'); d.className = `chat-msg msg-${sender}`; d.innerText = text; h.appendChild(d); h.scrollTop = h.scrollHeight; }

    function openUploadModal(input) {
        if (!input.files || !input.files[0]) return; const file = input.files[0]; const reader = new FileReader();
        reader.onload = function(e) { selectedFileBase64 = e.target.result.split(',')[1]; selectedFileMimeType = file.type; document.getElementById('preview-image').src = e.target.result; document.getElementById('prompt-input').value = ''; openModal('upload-modal'); };
        reader.readAsDataURL(file); input.value = '';
    }
    function submitImageWithPrompt() {
        if (!selectedFileBase64) return; closeModal('upload-modal'); document.getElementById('loading-overlay').style.display = 'flex';
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ image: selectedFileBase64, mimeType: selectedFileMimeType, prompt: document.getElementById('prompt-input').value }) })
        .then(r => r.json()).then(result => { document.getElementById('loading-overlay').style.display = 'none'; if(result.status === 'success') { alert(result.message); fetchData(); } else { alert('ã‚¨ãƒ©ãƒ¼: ' + result.message); } })
        .catch(err => { document.getElementById('loading-overlay').style.display = 'none'; alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼'); });
    }
    function normalizeCategory(c){if(!c)return'ãã®ä»–';if(c.includes('ä»•äº‹'))return'ä»•äº‹';if(c.includes('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ'))return'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ';if(c.includes('å­ä¾›')||c.includes('ã‚µãƒƒã‚«ãƒ¼'))return'ã‚µãƒƒã‚«ãƒ¼';return'ãã®ä»–';}
    function getColorByCategory(c){if(!c)return'#999';if(c.includes('ä»•äº‹'))return'#4285f4';if(c.includes('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ'))return'#db4437';if(c.includes('å­ä¾›')||c.includes('ã‚µãƒƒã‚«ãƒ¼'))return'#0f9d58';return'#999';}
    function getBorderColorClass(d){const t=new Date(new Date(d).setHours(0,0,0,0));const n=new Date(new Date().setHours(0,0,0,0));const df=Math.ceil((t-n)/(864e5));if(df===0||df===1)return'border-gold';if(df>1&&df<=3)return'border-red';if(df>3&&df<=7)return'border-blue';if(df>7&&df<=14)return'border-green';return'';}
</script>
</body>
</html>
