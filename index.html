<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¹ã‚±åŠ© - AIã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; overflow: hidden; }
        
        /* --- ç”»é¢åˆ†å‰²ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* ä¸Šéƒ¨ 1/3ï¼šã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        #timeline-area {
            flex: 1; /* 1/3ã®æ¯”ç‡ */
            background-color: #f5f5f5;
            border-bottom: 2px solid #ddd;
            overflow-x: auto; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            white-space: nowrap;
            padding: 10px;
            box-sizing: border-box;
        }

        /* ä¸‹éƒ¨ 2/3ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¨ãƒªã‚¢ */
        #calendar-area {
            flex: 2; /* 2/3ã®æ¯”ç‡ */
            padding: 10px;
            overflow-y: auto;
            position: relative;
        }

        /* --- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®è£…é£¾ --- */
        .timeline-column {
            display: inline-block;
            vertical-align: top;
            width: 140px;
            margin-right: 5px;
            background: #fff;
            border-radius: 8px;
            padding: 5px;
            min-height: 90%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .timeline-date {
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .timeline-event {
            padding: 5px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 0.8em;
            background-color: #fff;
            border-left: 5px solid #ccc; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ */
            white-space: normal; /* ãƒ†ã‚­ã‚¹ãƒˆæŠ˜ã‚Šè¿”ã— */
        }

        /* --- æ è‰²ã®ãƒ«ãƒ¼ãƒ«ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰ --- */
        .border-gold  { border: 2px solid #FFD700 !important; background-color: #ffffe0; } /* å‰æ—¥ãƒ»å½“æ—¥ */
        .border-red   { border: 2px solid #ff4d4d !important; } /* 3æ—¥ä»¥å†… */
        .border-blue  { border: 2px solid #4d79ff !important; } /* 1é€±é–“ä»¥å†… */
        .border-green { border: 2px solid #2eb82e !important; } /* 2é€±é–“ä»¥å†… */

        /* --- ã‚«ãƒ†ã‚´ãƒªè‰²ï¼ˆãƒ‰ãƒƒãƒˆã‚„å¸¯ã«ä½¿ç”¨ï¼‰ --- */
        .cat-work { color: #3366cc; border-color: #3366cc; }
        .cat-private { color: #dc3912; border-color: #dc3912; }
        .cat-soccer { color: #109618; border-color: #109618; }
        
        /* --- æ’®å½±ãƒœã‚¿ãƒ³ (FAB) --- */
        #camera-btn {
            position: absolute;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #4285f4;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            cursor: pointer;
        }
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            color: white;
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="timeline-area" id="timeline-container">
        <div style="padding:20px; color:#888;">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div id="calendar-area">
        <div id='calendar'></div>
    </div>
</div>

<div id="camera-btn" onclick="document.getElementById('file-input').click()">ğŸ“·</div>
<input type="file" id="file-input" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(this)">

<div id="loading-overlay">
    <div style="font-size: 2em;">ğŸ¤– è§£æä¸­...</div>
    <p>GeminiãŒç”»åƒã‚’èª­ã‚“ã§ã„ã¾ã™<br>ãã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„</p>
</div>

<script>
    // â–¼ ã‚ãªãŸã®GASã®URLã‚’è¨­å®šæ¸ˆã¿
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxS7p_2ekWJWMak9ivwKTbro11sD1QH9G2oVJOOMKpS9SKxaqJaxTf59FZvcC-_wsKg/exec";

    let allEvents = [];
    let calendar;

    document.addEventListener('DOMContentLoaded', function() {
        initCalendar();
        fetchData();
    });

    // 1. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    function initCalendar() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ja',
            height: '100%',
            headerToolbar: {
                left: 'prev,next',
                center: 'title',
                right: 'today'
            },
            eventClick: function(info) {
                alert(`ã€${info.event.title}ã€‘\næ—¥æ™‚: ${info.event.start.toLocaleString()}\nãƒ¡ãƒ¢: ${info.event.extendedProps.memo}`);
            },
            eventContent: function(arg) {
                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†…ã®è¡¨ç¤ºï¼ˆè‰²ãƒ‰ãƒƒãƒˆâ—ï¼‰
                let dotColor = getColorByCategory(arg.event.extendedProps.category);
                return { html: `<span style="color:${dotColor}; font-size:1.2em;">â—</span> ${arg.event.title}` };
            }
        });
        calendar.render();
    }

    // 2. ãƒ‡ãƒ¼ã‚¿ã®å–å¾— (GAS doGeT)
    function fetchData() {
        fetch(GAS_URL)
            .then(response => response.json())
            .then(data => {
                allEvents = data;
                updateCalendar(data);
                updateTimeline(data);
            })
            .catch(error => console.error('Error:', error));
    }

    // 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ›´æ–°
    function updateCalendar(data) {
        calendar.removeAllEvents();
        const events = data.map(item => ({
            title: item.title,
            start: item.start,
            end: item.end,
            extendedProps: { category: item.category, memo: item.memo }
        }));
        calendar.addEventSource(events);
    }

    // 4. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®æ›´æ–°ï¼ˆæ¨ªä¸¦ã³ï¼‰
    function updateTimeline(data) {
        const container = document.getElementById('timeline-area');
        container.innerHTML = ""; // ã‚¯ãƒªã‚¢

        // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const grouped = {};
        data.forEach(item => {
            const dateKey = new Date(item.start).toLocaleDateString();
            if (!grouped[dateKey]) grouped[dateKey] = [];
            grouped[dateKey].push(item);
        });

        // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
        const sortedDates = Object.keys(grouped).sort((a,b) => new Date(a) - new Date(b));

        // åˆ—ã‚’ä½œæˆ
        sortedDates.forEach(date => {
            const col = document.createElement('div');
            col.className = 'timeline-column';
            
            // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼
            const header = document.createElement('div');
            header.className = 'timeline-date';
            header.innerText = date;
            col.appendChild(header);

            // ãã®æ—¥ã®äºˆå®šã‚«ãƒ¼ãƒ‰
            grouped[date].forEach(event => {
                const card = document.createElement('div');
                card.className = `timeline-event ${getBorderColorClass(event.start)}`;
                
                // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®å·¦ç·šã®è‰²
                const catColor = getColorByCategory(event.category);
                card.style.borderLeftColor = catColor;

                card.innerHTML = `<strong>${event.title}</strong><br><span style="font-size:0.8em">${event.category}</span>`;
                col.appendChild(card);
            });
            container.appendChild(col);
        });
    }

    // 5. ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† (GAS doPost)
    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            
            document.getElementById('loading-overlay').style.display = 'flex'; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º

            reader.onload = function(e) {
                const base64 = e.target.result.split(',')[1]; // Base64éƒ¨åˆ†ã®ã¿æŠ½å‡º
                const payload = {
                    image: base64,
                    mimeType: file.type
                };

                // GASã¸é€ä¿¡
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(result => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    if(result.status === 'success') {
                        alert(result.message);
                        fetchData(); // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­è¾¼
                    } else {
                        alert('ã‚¨ãƒ©ãƒ¼: ' + result.message);
                    }
                })
                .catch(err => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + err);
                });
            };
            reader.readAsDataURL(file);
        }
    }

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---

    // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®è‰²å®šç¾©
    function getColorByCategory(cat) {
        if (!cat) return '#888';
        if (cat.includes('ä»•äº‹')) return '#3366cc'; // é’
        if (cat.includes('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ')) return '#dc3912'; // èµ¤
        if (cat.includes('å­ä¾›') || cat.includes('ã‚µãƒƒã‚«ãƒ¼')) return '#109618'; // ç·‘
        return '#888';
    }

    // æ—¥æ•°å·®ã«ã‚ˆã‚‹æ è‰²ã®æ±ºå®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æœ›ï¼‰
    function getBorderColorClass(dateStr) {
        const targetDate = new Date(dateStr);
        const today = new Date();
        const diffTime = targetDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

        if (diffDays <= 1) return 'border-gold';   // å‰æ—¥ãƒ»å½“æ—¥ãƒ»æ˜æ—¥
        if (diffDays <= 3) return 'border-red';    // 3æ—¥ä»¥å†…
        if (diffDays <= 7) return 'border-blue';   // 1é€±é–“ä»¥å†…
        if (diffDays <= 14) return 'border-green'; // 2é€±é–“ä»¥å†…
        return '';
    }
</script>

</body>
</html>
