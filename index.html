<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¹ã‚±åŠ© - AIã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body, html { margin: 0; padding: 0; height: 100%; font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; }
        
        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒ†ãƒŠ --- */
        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        #app-header {
            background-color: #fff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        #app-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #4285f4;
            display: flex;
            align-items: center;
        }
        #app-title span { margin-left: 10px; font-size: 0.8em; color: #666; }
        #user-info { font-weight: bold; color: #555; }

        /* --- ä¸Šéƒ¨ï¼šã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼ˆã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆé¢¨ï¼‰ --- */
        #timeline-area {
            flex: 1; /* ç”»é¢ã®1/3ç¨‹åº¦ */
            background-color: #fff;
            border-bottom: 2px solid #ddd;
            overflow: auto; /* ç¸¦æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
            position: relative;
            display: grid;
            /* å·¦å´ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ—å›ºå®šã€å³å´ã¯æ—¥ä»˜ã®æ•°ã ã‘åˆ—ã‚’ä½œã‚‹ */
            grid-template-columns: 120px repeat(auto-fill, minmax(100px, 1fr));
            grid-auto-rows: minmax(60px, auto);
        }

        /* ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ©ãƒ™ãƒ«åˆ— */
        .category-label {
            position: sticky;
            left: 0;
            background-color: #f8f9fa;
            z-index: 5;
            border-right: 2px solid #eee;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-weight: bold;
            color: #555;
        }
        /* æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .date-header {
            position: sticky;
            top: 0;
            background-color: #fff;
            z-index: 4;
            text-align: center;
            padding: 5px;
            border-bottom: 2px solid #eee;
            border-right: 1px solid #eee;
            font-weight: bold;
            color: #777;
        }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ã‚»ãƒ«ã¨ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ */
        .timeline-cell {
            border-right: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
            padding: 5px;
            vertical-align: top;
        }
        .timeline-event-card {
            padding: 6px 8px;
            margin-bottom: 5px;
            border-radius: 6px;
            font-size: 0.85em;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left-width: 6px; /* ã‚«ãƒ†ã‚´ãƒªè‰²ã¯å·¦ã®å¤ªç·šã§è¡¨ç¾ */
            border-left-style: solid;
            white-space: normal;
            overflow: hidden;
        }

        /* --- æ è‰²ã®ãƒ«ãƒ¼ãƒ«ï¼ˆã”è¦æœ›ã«ã‚ˆã‚Šå¤‰æ›´ï¼‰ --- */
        /* é‡‘è‰²ã‚’ã‚ˆã‚Šãƒªãƒƒãƒã«ã—ã€æ ã‚’å¤ªãå¼·èª¿ */
        .border-gold  { border: 4px solid #d4af37 !important; background-color: #fffbf0; } /* å‰æ—¥ãƒ»å½“æ—¥ */
        .border-red   { border: 2px solid #ff4d4d !important; } /* 3æ—¥ä»¥å†… */
        .border-blue  { border: 2px solid #4d79ff !important; } /* 1é€±é–“ä»¥å†… */
        .border-green { border: 2px solid #2eb82e !important; } /* 2é€±é–“ä»¥å†… */

        /* --- ä¸‹éƒ¨ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¨ãƒªã‚¢ --- */
        #calendar-area {
            flex: 2; /* ç”»é¢ã®2/3ç¨‹åº¦ */
            padding: 10px;
            overflow-y: auto;
            position: relative;
            background-color: #fff;
        }

        /* --- æ’®å½±ãƒœã‚¿ãƒ³ (FAB) --- */
        #camera-btn {
            position: absolute;
            bottom: 30px;
            right: 20px;
            width: 64px;
            height: 64px;
            background-color: #4285f4;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            box-shadow: 0 4px 10px rgba(66, 133, 244, 0.4);
            z-index: 100;
            cursor: pointer;
            transition: transform 0.1s;
        }
        #camera-btn:active { transform: scale(0.95); }
        
        /* --- ãƒ­ãƒ¼ãƒ‰ç”»é¢ --- */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            color: #4285f4;
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div id="app-container">
    <header id="app-header">
        <div id="app-title">ğŸ¤– ã‚¹ã‚±åŠ©<span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span></div>
        <div id="user-info">è¥¿æ‘å“² ã•ã‚“</div>
    </header>

    <div id="timeline-area">
        <div style="padding:20px; grid-column: 1 / -1; color:#888;">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

    <div id="calendar-area">
        <div id='calendar'></div>
    </div>
</div>

<div id="camera-btn" onclick="document.getElementById('file-input').click()">ğŸ“·</div>
<input type="file" id="file-input" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(this)">

<div id="loading-overlay">
    <div style="font-size: 2.5em; margin-bottom: 10px;">ğŸ¤–</div>
    <div style="font-size: 1.2em;">è§£æä¸­...</div>
    <p style="font-size: 0.9em; color: #666;">GeminiãŒç”»åƒã‚’èª­ã‚“ã§ã„ã¾ã™</p>
</div>

<script>
    // â–¼ ã‚ãªãŸã®GASã®URLï¼ˆãã®ã¾ã¾ä½¿ã„ã¾ã™ï¼‰
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxS7p_2ekWJWMak9ivwKTbro11sD1QH9G2oVJOOMKpS9SKxaqJaxTf59FZvcC-_wsKg/exec";

    let allEvents = [];
    let calendar;
    // è¡¨ç¤ºã™ã‚‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å®šç¾©ã¨ä¸¦ã³é †
    const CATEGORIES = ['ä»•äº‹', 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ', 'å­ä¾›', 'ã‚µãƒƒã‚«ãƒ¼', 'ãã®ä»–'];

    document.addEventListener('DOMContentLoaded', function() {
        initCalendar();
        fetchData();
    });

    // 1. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–ï¼ˆå¤‰æ›´ãªã—ï¼‰
    function initCalendar() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ja',
            height: '100%',
            headerToolbar: { left: 'title', right: 'today prev,next' },
            dayCellContent: function(e) { e.dayNumberText = e.dayNumberText.replace('æ—¥', ''); },
            eventClick: function(info) {
                alert(`ã€${info.event.title}ã€‘\næ—¥æ™‚: ${info.event.start.toLocaleString()}\nã‚«ãƒ†ã‚´ãƒªãƒ¼: ${info.event.extendedProps.category}\nãƒ¡ãƒ¢: ${info.event.extendedProps.memo}`);
            },
            eventContent: function(arg) {
                let dotColor = getColorByCategory(arg.event.extendedProps.category);
                return { html: `<span style="color:${dotColor}; font-size:1.2em; margin-right:4px;">â—</span><span style="font-size:0.9em;">${arg.event.title}</span>` };
            }
        });
        calendar.render();
    }

    // 2. ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆå¤‰æ›´ãªã—ï¼‰
    function fetchData() {
        fetch(GAS_URL)
            .then(response => response.json())
            .then(data => {
                allEvents = data;
                updateCalendar(data);
                updateTimeline(data);
            })
            .catch(error => console.error('Error:', error));
    }

    // 3. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ï¼ˆå¤‰æ›´ãªã—ï¼‰
    function updateCalendar(data) {
        calendar.removeAllEvents();
        const events = data.map(item => ({
            title: item.title, start: item.start, end: item.end,
            extendedProps: { category: item.category, memo: item.memo }
        }));
        calendar.addEventSource(events);
    }

    // 4. ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ›´æ–°ï¼ˆâ˜…ã“ã“ã‚’å¤§æ”¹é€ ã—ã¾ã—ãŸâ˜…ï¼‰
    function updateTimeline(data) {
        const container = document.getElementById('timeline-area');
        container.innerHTML = ""; // ã‚¯ãƒªã‚¢

        if (data.length === 0) {
            container.innerHTML = '<div style="padding:20px; grid-column:1/-1;">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’æ—¥ä»˜ã¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§æ•´ç†
        const eventsMap = {};
        let minDate = new Date(); let maxDate = new Date();
        
        data.forEach(item => {
            const dateStr = new Date(item.start).toLocaleDateString();
            const cat = normalizeCategory(item.category);
            if (!eventsMap[dateStr]) eventsMap[dateStr] = {};
            if (!eventsMap[dateStr][cat]) eventsMap[dateStr][cat] = [];
            eventsMap[dateStr][cat].push(item);

            const itemDate = new Date(item.start);
            if (itemDate < minDate) minDate = itemDate;
            if (itemDate > maxDate) maxDate = itemDate;
        });

        // è¡¨ç¤ºã™ã‚‹æ—¥ä»˜ã®ç¯„å›²ã‚’æ±ºå®šï¼ˆãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ç¯„å›²ï¼‹å‰å¾Œï¼‰
        minDate.setDate(minDate.getDate() - 2);
        maxDate.setDate(maxDate.getDate() + 14); // å°‘ãªãã¨ã‚‚2é€±é–“å…ˆã¾ã§
        const dateList = [];
        for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) {
            dateList.push(new Date(d));
        }

        // ã‚°ãƒªãƒƒãƒ‰ã®åˆ—æ•°ã‚’è¨­å®š
        container.style.gridTemplateColumns = `120px repeat(${dateList.length}, minmax(100px, 1fr))`;

        // --- ã‚°ãƒªãƒƒãƒ‰ã®æç”» ---

        // å·¦ä¸Šã®ç©ºç™½ã‚»ãƒ«
        const corner = document.createElement('div');
        corner.className = 'category-label';
        corner.style.gridRow = '1'; corner.style.gridColumn = '1';
        corner.innerHTML = '<span style="font-size:0.8em; color:#999;">ã‚«ãƒ†ã‚´ãƒªãƒ¼â•²æ—¥ä»˜</span>';
        container.appendChild(corner);

        // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼åˆ—ã®ä½œæˆ
        dateList.forEach((date, i) => {
            const header = document.createElement('div');
            header.className = 'date-header';
            header.style.gridRow = '1';
            header.style.gridColumn = `${i + 2}`; // 1åˆ—ç›®ã¯ã‚«ãƒ†ã‚´ãƒªãªã®ã§+2
            const dayOfWeek = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][date.getDay()];
            header.innerHTML = `${date.getMonth()+1}/${date.getDate()}<br><span style="font-size:0.8em;">(${dayOfWeek})</span>`;
            if(date.getDay() === 0) header.style.color = '#dc3912'; // æ—¥æ›œèµ¤
            if(date.getDay() === 6) header.style.color = '#3366cc'; // åœŸæ›œé’
            container.appendChild(header);
        });

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼è¡Œã®ä½œæˆ
        CATEGORIES.forEach((cat, catIndex) => {
            // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ©ãƒ™ãƒ«ï¼ˆå·¦ç«¯å›ºå®šï¼‰
            const label = document.createElement('div');
            label.className = 'category-label';
            label.style.gridRow = `${catIndex + 2}`;
            label.style.gridColumn = '1';
            label.style.borderLeft = `6px solid ${getColorByCategory(cat)}`;
            label.innerText = cat;
            container.appendChild(label);

            // å„æ—¥ä»˜ã®ã‚»ãƒ«ã¨äºˆå®šã‚«ãƒ¼ãƒ‰ã®ä½œæˆ
            dateList.forEach((date, dateIndex) => {
                const cell = document.createElement('div');
                cell.className = 'timeline-cell';
                cell.style.gridRow = `${catIndex + 2}`;
                cell.style.gridColumn = `${dateIndex + 2}`;

                const dateStr = date.toLocaleDateString();
                if (eventsMap[dateStr] && eventsMap[dateStr][cat]) {
                    eventsMap[dateStr][cat].forEach(event => {
                        const card = document.createElement('div');
                        // â˜…ã“ã“ã§å¤ªã„é‡‘è‰²ã®æ ç·šã‚¯ãƒ©ã‚¹ãªã©ã‚’é©ç”¨â˜…
                        card.className = `timeline-event-card ${getBorderColorClass(event.start)}`;
                        card.style.borderLeftColor = getColorByCategory(event.category);
                        card.innerHTML = `<strong>${event.title}</strong>`;
                        cell.appendChild(card);
                    });
                }
                container.appendChild(cell);
            });
        });

        // ä»Šæ—¥ã®æ—¥ä»˜ä»˜è¿‘ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
        setTimeout(() => {
            const todayHeader = Array.from(container.querySelectorAll('.date-header')).find(h => h.textContent.includes(`${new Date().getMonth()+1}/${new Date().getDate()}`));
            if(todayHeader) todayHeader.scrollIntoView({ inline: 'center', block: 'nearest' });
        }, 500);
    }

    // 5. ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ãªã—ï¼‰
    function handleImageUpload(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const reader = new FileReader();
        document.getElementById('loading-overlay').style.display = 'flex';
        reader.onload = function(e) {
            const base64 = e.target.result.split(',')[1];
            fetch(GAS_URL, {
                method: 'POST', body: JSON.stringify({ image: base64, mimeType: file.type })
            })
            .then(response => response.json())
            .then(result => {
                document.getElementById('loading-overlay').style.display = 'none';
                if(result.status === 'success') { alert(result.message); fetchData(); }
                else { alert('ã‚¨ãƒ©ãƒ¼: ' + result.message); }
            })
            .catch(err => {
                document.getElementById('loading-overlay').style.display = 'none';
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + err);
            });
        };
        reader.readAsDataURL(file);
        input.value = ''; // ãƒªã‚»ãƒƒãƒˆ
    }

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

    // ã‚«ãƒ†ã‚´ãƒªåã®æºã‚‰ãã‚’å¸å
    function normalizeCategory(cat) {
        if (!cat) return 'ãã®ä»–';
        if (cat.includes('ä»•äº‹')) return 'ä»•äº‹';
        if (cat.includes('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ')) return 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ';
        if (cat.includes('å­ä¾›') || cat.includes('ã‚µãƒƒã‚«ãƒ¼')) return 'ã‚µãƒƒã‚«ãƒ¼';
        return 'ãã®ä»–';
    }

    // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®è‰²
    function getColorByCategory(cat) {
        if (!cat) return '#999';
        if (cat.includes('ä»•äº‹')) return '#4285f4'; // é’ç³»
        if (cat.includes('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ')) return '#db4437'; // èµ¤ç³»
        if (cat.includes('å­ä¾›') || cat.includes('ã‚µãƒƒã‚«ãƒ¼')) return '#0f9d58'; // ç·‘ç³»
        return '#999'; // ãã®ä»–ã‚°ãƒ¬ãƒ¼
    }

    // æ—¥æ•°å·®ã«ã‚ˆã‚‹æ è‰²ï¼ˆâ˜…ã“ã“ã‚’èª¿æ•´ã—ã¾ã—ãŸâ˜…ï¼‰
    function getBorderColorClass(dateStr) {
        const targetDate = new Date(new Date(dateStr).setHours(0,0,0,0));
        const today = new Date(new Date().setHours(0,0,0,0));
        const diffTime = targetDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

        if (diffDays === 0 || diffDays === 1) return 'border-gold'; // å½“æ—¥ãƒ»ç¿Œæ—¥ã‚’ã‚´ãƒ¼ãƒ«ãƒ‰ã«
        if (diffDays > 1 && diffDays <= 3) return 'border-red';     // 3æ—¥ä»¥å†…
        if (diffDays > 3 && diffDays <= 7) return 'border-blue';    // 1é€±é–“ä»¥å†…
        if (diffDays > 7 && diffDays <= 14) return 'border-green';  // 2é€±é–“ä»¥å†…
        return '';
    }
</script>
</body>
</html>
