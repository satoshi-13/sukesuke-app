<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¹ã‚±åŠ©</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body, html { margin: 0; padding: 0; height: 100%; font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; overflow: hidden; }
        #app-container { display: flex; flex-direction: column; height: 100vh; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        #app-header { background: #fff; padding: 10px 15px; display: flex; justify-content: flex-end; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); height: 50px; box-sizing: border-box; }
        #user-info { font-weight: bold; color: #555; font-size: 0.9em; }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        #timeline-area { flex: 1; background: #fff; border-bottom: 2px solid #ddd; overflow: auto; display: grid; grid-template-columns: 90px repeat(auto-fill, minmax(90px, 1fr)); grid-auto-rows: minmax(50px, auto); }
        .category-label { position: sticky; left: 0; background: #f8f9fa; z-index: 5; border-right: 2px solid #eee; border-bottom: 1px solid #eee; display: flex; align-items: center; padding: 0 5px; font-weight: bold; color: #555; font-size: 0.8em; }
        .date-header { position: sticky; top: 0; background: #fff; z-index: 4; text-align: center; padding: 5px; border-bottom: 2px solid #eee; border-right: 1px solid #eee; font-weight: bold; color: #777; font-size: 0.8em; }
        .timeline-cell { border-right: 1px solid #f0f0f0; border-bottom: 1px solid #f0f0f0; padding: 2px; vertical-align: top; }
        .timeline-event-card { padding: 4px 6px; margin-bottom: 3px; border-radius: 4px; font-size: 0.75em; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-left-width: 5px; border-left-style: solid; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; /* ã‚¿ãƒƒãƒ—å¯èƒ½ã« */ }

        /* æ è‰² */
        .border-gold  { border: 3px solid #d4af37 !important; background-color: #fffbf0; }
        .border-red   { border: 2px solid #ff4d4d !important; }
        .border-blue  { border: 2px solid #4d79ff !important; }
        .border-green { border: 2px solid #2eb82e !important; }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        #calendar-area { flex: 2; padding: 5px; background: #fff; overflow: hidden; }
        .fc-event-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.85em; }
        .fc-toolbar-title { font-size: 1.2em !important; }
        .fc .fc-button { padding: 4px 8px; font-size: 0.9em; }

        /* --- ãƒœã‚¿ãƒ³ç¾¤ (FAB) --- */
        .fab-container { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 100; }
        .fab-btn { width: 56px; height: 56px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; color: white; transition: transform 0.1s; }
        .fab-btn:active { transform: scale(0.95); }
        #camera-btn { background-color: #4285f4; }
        #chat-btn { background-color: #34a853; } /* ãƒãƒ£ãƒƒãƒˆã¯ç·‘ */

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1500; justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 90%; max-width: 400px; border-radius: 12px; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; max-height: 80vh; }
        
        /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ */
        #preview-image { width: 100%; max-height: 200px; object-fit: contain; margin-bottom: 15px; border-radius: 8px; border: 1px solid #eee; }
        #prompt-input { width: 100%; height: 80px; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; font-family: inherit; resize: none; }
        
        /* ãƒãƒ£ãƒƒãƒˆç”¨ */
        #chat-history { flex: 1; overflow-y: auto; margin-bottom: 10px; border: 1px solid #eee; border-radius: 8px; padding: 10px; background: #f9f9f9; min-height: 200px; }
        .chat-msg { margin-bottom: 8px; padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 0.9em; line-height: 1.4; }
        .msg-user { background: #e3f2fd; align-self: flex-end; margin-left: auto; color: #333; }
        .msg-ai { background: #fff; border: 1px solid #ddd; align-self: flex-start; margin-right: auto; color: #333; }
        .chat-input-area { display: flex; gap: 5px; }
        #chat-input-text { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; }

        /* ãƒœã‚¿ãƒ³å…±é€š */
        .btn { padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; flex: 1; margin: 0 5px; }
        .btn-cancel { background: #eee; color: #555; }
        .btn-submit { background: #4285f4; color: white; }

        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); color: #4285f4; z-index: 2000; justify-content: center; align-items: center; flex-direction: column; font-weight: bold; }
    </style>
</head>
<body>

<div id="app-container">
    <header id="app-header"><div id="user-info">è¥¿æ‘å“² ã•ã‚“</div></header>
    <div id="timeline-area"><div style="padding:20px; grid-column:1/-1; color:#888;">èª­ã¿è¾¼ã¿ä¸­...</div></div>
    <div id="calendar-area"><div id='calendar'></div></div>
</div>

<div class="fab-container">
    <div id="chat-btn" class="fab-btn" onclick="openChatModal()">ğŸ’¬</div>
    <div id="camera-btn" class="fab-btn" onclick="document.getElementById('file-input').click()">ğŸ“·</div>
</div>
<input type="file" id="file-input" accept="image/*" style="display: none;" onchange="openUploadModal(this)">

<div id="upload-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="font-weight:bold; margin-bottom:10px;">AIã¸ã®æŒ‡ç¤º (ä»»æ„)</div>
        <img id="preview-image" src="">
        <textarea id="prompt-input" placeholder="ä¾‹ï¼šã‚µãƒƒã‚«ãƒ¼ã®äºˆå®šã ã‘ç™»éŒ²ã—ã¦ã€‚"></textarea>
        <div style="display: flex; justify-content: space-between;">
            <button class="btn btn-cancel" onclick="closeModal('upload-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-submit" onclick="submitImageWithPrompt()">é€ä¿¡</button>
        </div>
    </div>
</div>

<div id="chat-modal" class="modal-overlay">
    <div class="modal-content" style="height: 70vh;">
        <div style="font-weight:bold; margin-bottom:10px; display:flex; justify-content:space-between;">
            <span>ğŸ¤– ã‚¹ã‚±åŠ©ãƒãƒ£ãƒƒãƒˆ</span>
            <span onclick="closeModal('chat-modal')" style="cursor:pointer;">âœ•</span>
        </div>
        <div id="chat-history">
            <div class="chat-msg msg-ai">ã“ã‚“ã«ã¡ã¯ï¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã“ã¨ãªã‚‰ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã€‚</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input-text" placeholder="ä¾‹: ä»Šæœˆã®å…¬ä¼‘ã¯ã„ã¤ï¼Ÿ">
            <button class="fab-btn" style="width:40px; height:40px; font-size:16px; background:#4285f4; margin:0;" onclick="sendChatMessage()">â¤</button>
        </div>
    </div>
</div>

<div id="loading-overlay"><div style="font-size: 2em; margin-bottom: 10px;">ğŸ¤–</div><div>å‡¦ç†ä¸­...</div></div>

<script>
    // â–¼ GASã®URLï¼ˆã‚ãªãŸã®URLï¼‰
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxS7p_2ekWJWMak9ivwKTbro11sD1QH9G2oVJOOMKpS9SKxaqJaxTf59FZvcC-_wsKg/exec";

    let allEvents = [];
    let calendar;
    let selectedFileBase64 = null;
    let selectedFileMimeType = null;
    const CATEGORIES = ['ä»•äº‹', 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ', 'å­ä¾›', 'ã‚µãƒƒã‚«ãƒ¼', 'ãã®ä»–'];

    document.addEventListener('DOMContentLoaded', function() { initCalendar(); fetchData(); });

    function initCalendar() {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', locale: 'ja', height: '100%', contentHeight: 'auto', dayMaxEvents: true, fixedWeekCount: false,
            headerToolbar: { left: 'title', right: 'today prev,next' },
            dayCellContent: function(e) { e.dayNumberText = e.dayNumberText.replace('æ—¥', ''); },
            eventClick: function(info) { showEventDetail(info.event); }, // ã‚¯ãƒªãƒƒã‚¯è©³ç´°è¡¨ç¤º
            eventContent: function(arg) {
                let dotColor = getColorByCategory(arg.event.extendedProps.category);
                return { html: `<span style="color:${dotColor}; font-size:1em; margin-right:3px;">â—</span>${arg.event.title}` };
            }
        });
        calendar.render();
    }

    function fetchData() {
        fetch(GAS_URL).then(r=>r.json()).then(d=>{ allEvents=d; updateCalendar(d); updateTimeline(d); }).catch(e=>console.error(e));
    }
    function updateCalendar(d) { calendar.removeAllEvents(); calendar.addEventSource(d.map(i=>({title:i.title,start:i.start,end:i.end,extendedProps:{category:i.category,memo:i.memo}}))); }

    // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ›´æ–°ï¼ˆã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ ï¼‰
    function updateTimeline(data) {
        const container = document.getElementById('timeline-area'); container.innerHTML = "";
        if (data.length === 0) { container.innerHTML = '<div style="padding:20px; grid-column:1/-1;">äºˆå®šãªã—</div>'; return; }
        const eventsMap = {}; let minDate = new Date(); let maxDate = new Date();
        data.forEach(item => {
            const dateStr = new Date(item.start).toLocaleDateString(); const cat = normalizeCategory(item.category);
            if (!eventsMap[dateStr]) eventsMap[dateStr] = {}; if (!eventsMap[dateStr][cat]) eventsMap[dateStr][cat] = [];
            eventsMap[dateStr][cat].push(item); const itemDate = new Date(item.start); if (itemDate < minDate) minDate = itemDate; if (itemDate > maxDate) maxDate = itemDate;
        });
        minDate.setDate(minDate.getDate() - 2); maxDate.setDate(maxDate.getDate() + 14);
        const dateList = []; for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 1)) dateList.push(new Date(d));
        container.style.gridTemplateColumns = `90px repeat(${dateList.length}, minmax(90px, 1fr))`;
        const corner = document.createElement('div'); corner.className = 'category-label'; corner.style.gridRow = '1'; corner.style.gridColumn = '1'; corner.innerHTML = 'ã‚«ãƒ†ã‚´ãƒªãƒ¼'; container.appendChild(corner);
        dateList.forEach((date, i) => {
            const header = document.createElement('div'); header.className = 'date-header'; header.style.gridRow = '1'; header.style.gridColumn = `${i + 2}`;
            header.innerHTML = `${date.getMonth()+1}/${date.getDate()}(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][date.getDay()]})`;
            if(date.getDay()===0) header.style.color='#dc3912'; if(date.getDay()===6) header.style.color='#3366cc'; container.appendChild(header);
        });
        CATEGORIES.forEach((cat, catIndex) => {
            const label = document.createElement('div'); label.className = 'category-label'; label.style.gridRow = `${catIndex + 2}`; label.style.gridColumn = '1'; label.style.borderLeft = `4px solid ${getColorByCategory(cat)}`; label.innerText = cat; container.appendChild(label);
            dateList.forEach((date, dateIndex) => {
                const cell = document.createElement('div'); cell.className = 'timeline-cell'; cell.style.gridRow = `${catIndex + 2}`; cell.style.gridColumn = `${dateIndex + 2}`;
                const dateStr = date.toLocaleDateString();
                if (eventsMap[dateStr] && eventsMap[dateStr][cat]) {
                    eventsMap[dateStr][cat].forEach(event => {
                        const card = document.createElement('div'); 
                        card.className = `timeline-event-card ${getBorderColorClass(event.start)}`; 
                        card.style.borderLeftColor = getColorByCategory(cat); 
                        card.innerHTML = event.title; 
                        
                        // â˜…ã“ã“ï¼šã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¿ãƒƒãƒ—æ™‚ã®å‡¦ç†ã‚’è¿½åŠ 
                        card.onclick = function() {
                             // ç°¡æ˜“çš„ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã£ã¦è©³ç´°è¡¨ç¤ºé–¢æ•°ã¸
                            showEventDetail({ 
                                title: event.title, 
                                start: new Date(event.start), 
                                extendedProps: { category: event.category, memo: event.memo } 
                            });
                        };
                        
                        cell.appendChild(card);
                    });
                } container.appendChild(cell);
            });
        });
        setTimeout(() => { const t=Array.from(container.querySelectorAll('.date-header')).find(h=>h.textContent.includes(`${new Date().getMonth()+1}/${new Date().getDate()}`)); if(t)t.scrollIntoView({inline:'center',block:'nearest'}); }, 500);
    }

    // â˜…æ–°è¦ï¼šè©³ç´°è¡¨ç¤ºï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³å…±é€šï¼‰
    function showEventDetail(eventObj) {
        const timeStr = eventObj.start.toLocaleString();
        const cat = eventObj.extendedProps.category || 'ãªã—';
        const memo = eventObj.extendedProps.memo || 'ãªã—';
        alert(`ã€${eventObj.title}ã€‘\n----------------\næ—¥æ™‚: ${timeStr}\nã‚«ãƒ†ã‚´ãƒªãƒ¼: ${cat}\nãƒ¡ãƒ¢: ${memo}`);
    }

    // â˜…æ–°è¦ï¼šãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
    function openChatModal() { document.getElementById('chat-modal').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function sendChatMessage() {
        const input = document.getElementById('chat-input-text');
        const text = input.value.trim();
        if(!text) return;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¹ãå‡ºã—è¿½åŠ 
        addChatBubble(text, 'user');
        input.value = '';

        // GASã¸é€ä¿¡
        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ type: 'chat', text: text })
        })
        .then(r => r.json())
        .then(res => {
            if(res.status === 'success') {
                addChatBubble(res.answer, 'ai');
            } else {
                addChatBubble("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", 'ai');
            }
        })
        .catch(e => {
            addChatBubble("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e, 'ai');
        });
    }

    function addChatBubble(text, sender) {
        const history = document.getElementById('chat-history');
        const div = document.createElement('div');
        div.className = `chat-msg msg-${sender}`;
        div.innerText = text;
        history.appendChild(div);
        history.scrollTop = history.scrollHeight; // æœ€ä¸‹éƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    }

    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼ˆæ—¢å­˜ï¼‰
    function openUploadModal(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            selectedFileBase64 = e.target.result.split(',')[1]; selectedFileMimeType = file.type;
            document.getElementById('preview-image').src = e.target.result; document.getElementById('prompt-input').value = '';
            document.getElementById('upload-modal').style.display = 'flex';
        };
        reader.readAsDataURL(file); input.value = '';
    }
    function submitImageWithPrompt() {
        if (!selectedFileBase64) return;
        closeModal('upload-modal'); document.getElementById('loading-overlay').style.display = 'flex';
        const userPrompt = document.getElementById('prompt-input').value;
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ image: selectedFileBase64, mimeType: selectedFileMimeType, prompt: userPrompt }) })
        .then(r => r.json()).then(result => {
            document.getElementById('loading-overlay').style.display = 'none';
            if(result.status === 'success') { alert(result.message); fetchData(); } else { alert('ã‚¨ãƒ©ãƒ¼: ' + result.message); }
        }).catch(err => { document.getElementById('loading-overlay').style.display = 'none'; alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + err); });
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    function normalizeCategory(c){if(!c)return'ãã®ä»–';if(c.includes('ä»•äº‹'))return'ä»•äº‹';if(c.includes('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ'))return'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ';if(c.includes('å­ä¾›')||c.includes('ã‚µãƒƒã‚«ãƒ¼'))return'ã‚µãƒƒã‚«ãƒ¼';return'ãã®ä»–';}
    function getColorByCategory(c){if(!c)return'#999';if(c.includes('ä»•äº‹'))return'#4285f4';if(c.includes('ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ'))return'#db4437';if(c.includes('å­ä¾›')||c.includes('ã‚µãƒƒã‚«ãƒ¼'))return'#0f9d58';return'#999';}
    function getBorderColorClass(d){const t=new Date(new Date(d).setHours(0,0,0,0));const n=new Date(new Date().setHours(0,0,0,0));const df=Math.ceil((t-n)/(864e5));if(df===0||df===1)return'border-gold';if(df>1&&df<=3)return'border-red';if(df>3&&df<=7)return'border-blue';if(df>7&&df<=14)return'border-green';return'';}
</script>
</body>
</html>
