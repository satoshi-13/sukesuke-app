<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <title>ã‚¹ã‚±åŠ©</title>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <style>
    /* --- åŸºæœ¬è¨­å®š --- */
    body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #fff; overflow: hidden; overscroll-behavior: none; }
    #app-container { display: flex; flex-direction: column; height: 100vh; height: 100dvh; width: 100vw; overflow: hidden; position: fixed; top: 0; left: 0; }

    /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå›ºå®šï¼‰ --- */
    #app-header { background: #fff; padding: 0 12px; display: flex; justify-content: space-between; align-items: center; height: 36px; min-height: 36px; max-height: 36px; flex-shrink: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-bottom: 1px solid #ddd; }
    .header-logo { font-weight: bold; color: #4285f4; font-size: 1.1em; }
    .header-controls { display: flex; align-items: center; gap: 10px; }
    .btn-setting { font-size: 1.2em; cursor: pointer; color: #555; padding: 5px; }
    #user-name-display { font-size: 0.85em; font-weight: bold; color: #333; }

    /* â˜…â˜…â˜… ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ”¹å–„ç‰ˆ - ä¸Šä¸‹å·¦å³ç‹¬ç«‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆé«˜ã•å›ºå®šï¼‰ â˜…â˜…â˜… */
    #timeline-wrapper {
      height: 140px;
      min-height: 140px;
      max-height: 140px;
      flex-shrink: 0;
      display: grid;
      grid-template-columns: 65px 1fr;
      grid-template-rows: 22px 1fr;
      border-bottom: 2px solid #ccc;
      overflow: hidden;
    }

    /* å·¦ä¸Šã‚³ãƒ¼ãƒŠãƒ¼ï¼ˆå›ºå®šï¼‰ */
    .timeline-corner {
      grid-row: 1;
      grid-column: 1;
      background: #f5f5f5;
      border-right: 2px solid #ddd;
      border-bottom: 2px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.55em;
      font-weight: bold;
      color: #666;
      z-index: 10;
    }

    /* æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
    .timeline-header-row {
      grid-row: 1;
      grid-column: 2;
      display: flex;
      overflow-x: hidden;
      overflow-y: hidden;
      border-bottom: 2px solid #ddd;
      background: #fff;
    }
    .timeline-header-row::-webkit-scrollbar { display: none; }
    
    .date-header-cell {
      flex: 0 0 48px;
      min-width: 48px;
      height: 22px;
      line-height: 22px;
      text-align: center;
      font-weight: bold;
      font-size: 0.55em;
      border-right: 1px solid #eee;
      box-sizing: border-box;
      background: #fff;
    }
    .date-header-cell.sunday { color: #d00; }
    .date-header-cell.saturday { color: #00c; }
    .date-header-cell.today { background: #fff3cd; }

    /* ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ©ãƒ™ãƒ«åˆ—ï¼ˆç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
    .timeline-category-col {
      grid-row: 2;
      grid-column: 1;
      overflow-y: hidden;
      overflow-x: hidden;
      border-right: 2px solid #ddd;
      background: #f8f9fa;
    }
    .timeline-category-col::-webkit-scrollbar { display: none; }

    .category-label-cell {
      height: 29px;
      min-height: 29px;
      max-height: 29px;
      display: flex;
      align-items: center;
      padding: 0 4px;
      font-weight: bold;
      font-size: 0.55em;
      color: #555;
      border-bottom: 1px solid #eee;
      box-sizing: border-box;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒªã‚¢ï¼ˆä¸Šä¸‹å·¦å³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
    .timeline-data-area {
      grid-row: 2;
      grid-column: 2;
      overflow: auto;
      background: #fff;
    }
    .timeline-data-area::-webkit-scrollbar { width: 3px; height: 3px; }
    .timeline-data-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }

    .timeline-data-grid {
      display: grid;
    }

    .timeline-cell {
      width: 48px;
      min-width: 48px;
      height: 29px;
      min-height: 29px;
      max-height: 29px;
      border-right: 1px solid #f0f0f0;
      border-bottom: 1px solid #eee;
      padding: 1px;
      box-sizing: border-box;
      overflow: hidden;
      cursor: pointer;
    }
    .timeline-cell:active { background-color: #f0f8ff; }
    .timeline-cell.today-col { background: #fffde7; }

    /* äºˆå®šã‚«ãƒ¼ãƒ‰ï¼ˆ2å€‹è¡¨ç¤ºå¯èƒ½ï¼‰ */
    .timeline-event-card { 
      padding: 0 2px;
      border-radius: 2px; 
      font-size: 0.5em;
      background: #fff; 
      border-left-width: 2px;
      border-left-style: solid; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis; 
      height: 12px;
      line-height: 12px;
      margin-bottom: 1px;
    }

    /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæ®‹ã‚Šã®é«˜ã•ã‚’ä½¿ç”¨ã€å›ºå®šï¼‰ --- */
    #calendar-area { flex: 1; min-height: 0; padding: 0; background: #fff; overflow: hidden; position: relative; }
    #calendar { height: 100%; padding: 2px; padding-bottom: 2px; overflow: hidden; }
    
    /* FullCalendarèª¿æ•´ */
    .fc-toolbar-title { font-size: 0.95em !important; font-weight: bold; color: #333; }
    .fc-header-toolbar { margin-bottom: 0 !important; padding: 2px 0 !important; height: 28px !important; }
    .fc-daygrid-day-number { color: #888 !important; font-size: 0.7em !important; text-decoration: none !important; padding: 1px 2px !important; }
    .fc-event-title { white-space: nowrap; overflow: hidden; text-overflow: clip !important; }
    .fc-daygrid-event { white-space: nowrap; overflow: hidden; font-size: 0.6em !important; padding: 0 1px !important; margin: 0 !important; line-height: 1.1 !important; }
    .fc-daygrid-day-events { margin: 0 !important; padding: 0 !important; }
    .fc-daygrid-event-harness { margin: 0 !important; }
    .fc-daygrid-day-frame { padding: 0 !important; }
    .fc-daygrid-day { min-height: 0 !important; }
    .fc-button { padding: 2px 5px !important; font-size: 0.7em !important; }
    .fc-col-header-cell { padding: 2px 0 !important; font-size: 0.75em !important; }
    .fc-scrollgrid { border: none !important; }
    .fc-theme-standard td, .fc-theme-standard th { border-color: #e0e0e0 !important; }
    .fc .fc-daygrid-day-top { padding: 0 !important; display: flex; justify-content: flex-end; }
    .fc-view-harness { height: 100% !important; }
    .fc-daygrid { height: 100% !important; }
    .fc-scrollgrid-section-body > td { height: 100% !important; }
    .fc-daygrid-body { height: 100% !important; }
    .fc-scrollgrid-sync-table { height: 100% !important; }

    /* --- ç·Šæ€¥åº¦æ  --- */
    .border-gold { border: 2px solid gold !important; }
    .border-red { border: 2px solid #ff4d4d !important; }
    .border-blue { border: 2px solid #4d79ff !important; }
    .border-green { border: 2px solid #2eb82e !important; }

    /* --- FABã‚¢ã‚¤ã‚³ãƒ³ --- */
    .fab-container { position: absolute; bottom: 15px; right: 15px; display: flex; gap: 12px; z-index: 100; align-items: flex-end; pointer-events: none; }
    .fab-btn { pointer-events: auto; width: 44px; height: 44px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 18px; box-shadow: 0 3px 6px rgba(0,0,0,0.3); cursor: pointer; color: white; transition: transform 0.1s; }
    .fab-btn:active { transform: scale(0.95); }
    #btn-add { background: linear-gradient(135deg, #f093fb, #f5576c); font-size: 20px; font-weight: bold; }
    #btn-chat { background: #34a853; }
    #btn-camera { background: linear-gradient(135deg, #667eea, #764ba2); }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
    .modal-content { background: #fff; width: 85%; max-width: 350px; border-radius: 12px; padding: 20px; box-sizing: border-box; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; font-size: 11px; color: #666; margin-bottom: 4px; font-weight: bold; }
    .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
    .checkbox-group { display: flex; align-items: center; gap: 5px; margin-bottom: 10px; font-size: 14px; }
    
    /* ã‚«ãƒ†ã‚´ãƒªè¨­å®šè¡Œ */
    #cat-setting-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
    .cat-edit-row { 
      display: flex; gap: 10px; align-items: center; 
      background: #f9f9f9; padding: 8px 10px; border-radius: 6px; border: 1px solid #eee; 
    }
    .cat-color-box {
      width: 32px;
      height: 32px;
      min-width: 32px;
      border: 2px solid #999;
      border-radius: 6px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .cat-edit-color { display: none; }
    .cat-name-input { 
      flex: 1 1 auto;
      min-width: 0;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
      background: #fff;
    }
    .btn-del-cat { 
      width: 32px;
      height: 32px;
      min-width: 32px;
      border-radius: 6px;
      background: #ffcccc;
      color: #c00;
      border: none;
      cursor: pointer;
      font-weight: bold;
      flex-shrink: 0;
      font-size: 16px;
      line-height: 32px;
      text-align: center;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-del-cat:active { background: #ffaaaa; }

    .modal-actions { display: flex; gap: 10px; margin-top: 15px; }
    .btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
    .btn-cancel { background: #eee; color: #333; }
    .btn-save { background: #007bff; color: white; }
    .btn-danger { background: #ff4d4d; color: white; }

    .cell-detail-list { max-height: 200px; overflow-y: auto; margin-bottom: 10px; }
    .cell-detail-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
    
    #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 4000; justify-content: center; align-items: center; flex-direction: column; color: #4285f4; font-weight: bold; }
    
    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    #toast-container { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); z-index: 5000; pointer-events: none; }
    .toast { background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 0.85em; margin-bottom: 8px; opacity: 0; transform: translateY(-10px); transition: opacity 0.3s, transform 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.3); text-align: center; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: #34a853; }
    .toast.error { background: #ea4335; }
    .toast.info { background: #4285f4; }
  </style>
</head>
<body>
  <div id="app-container">
    <header id="app-header">
      <div class="header-logo">ã‚¹ã‚±åŠ©</div>
      <div class="header-controls">
        <span class="btn-setting" onclick="openSettings()">âš™ï¸</span>
        <span id="user-name-display">ã‚²ã‚¹ãƒˆ ã•ã‚“</span>
      </div>
    </header>
    
    <div id="timeline-wrapper">
      <div class="timeline-corner">Category</div>
      <div class="timeline-header-row" id="timeline-header"></div>
      <div class="timeline-category-col" id="timeline-categories"></div>
      <div class="timeline-data-area" id="timeline-data"></div>
    </div>

    <div id="calendar-area"><div id='calendar'></div></div>
  </div>

  <div class="fab-container">
    <div id="btn-add" class="fab-btn" onclick="openAddModal()">â•</div>
    <div id="btn-chat" class="fab-btn" onclick="openModal('chat-modal')">ğŸ’¬</div>
    <div id="btn-camera" class="fab-btn" onclick="openImageMenu()">ğŸ“·</div>
  </div>
  
  <!-- ç”»åƒé¸æŠãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div id="image-menu-modal" class="modal-overlay" onclick="closeModal('image-menu-modal')">
    <div class="modal-content" style="max-width:280px;" onclick="event.stopPropagation()">
      <h3 style="margin-top:0; text-align:center;">ğŸ“· ç”»åƒã‚’è¿½åŠ </h3>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <button class="btn btn-save" onclick="selectCamera()" style="padding:15px; font-size:16px;">ğŸ“¸ ã‚«ãƒ¡ãƒ©ã§æ’®å½±</button>
        <button class="btn" onclick="selectGallery()" style="padding:15px; font-size:16px; background:#f0f0f0; color:#333;">ğŸ–¼ï¸ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸æŠ</button>
        <button class="btn btn-cancel" onclick="closeModal('image-menu-modal')" style="margin-top:5px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  
  <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;" onchange="handleImageSelect(this)">
  <input type="file" id="gallery-input" accept="image/*" style="display: none;" onchange="handleImageSelect(this)">

  <div id="loading-overlay"><div>ğŸ”„</div><div id="loading-text">å‡¦ç†ä¸­...</div></div>
  <div id="toast-container"></div>

  <!-- äºˆå®šè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="add-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">äºˆå®šã‚’è¿½åŠ </h3>
      <div class="form-group"><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" id="inp-title" placeholder="ä¾‹ï¼šä¼šè­°"></div>
      <div class="form-group"><label>ã‚«ãƒ†ã‚´ãƒªãƒ¼</label><select id="inp-category"></select></div>
      <div class="checkbox-group"><input type="checkbox" id="inp-allday" onchange="toggleTimeInput()"><label for="inp-allday">çµ‚æ—¥</label></div>
      <div class="form-group"><label>é–‹å§‹</label><input type="datetime-local" id="inp-start"></div>
      <div class="form-group"><label>çµ‚äº†</label><input type="datetime-local" id="inp-end"></div>
      <div class="form-group"><label>ãƒ¡ãƒ¢</label><input type="text" id="inp-memo"></div>
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="closeModal('add-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-save" onclick="submitManual()">ç™»éŒ²</button>
      </div>
    </div>
  </div>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">è¨­å®š</h3>
      <div class="form-group"><label>è¡¨ç¤ºå</label><input type="text" id="set-name"></div>
      <div class="form-group">
        <label>ã‚«ãƒ†ã‚´ãƒªãƒ¼è¨­å®š</label>
        <div id="cat-setting-list"></div>
        <button class="btn" style="width:100%; margin-top:5px; background:#f0f0f0; font-size:0.8em;" onclick="addCatSettingRow()">ï¼‹ ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </button>
      </div>
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="closeModal('settings-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-save" onclick="saveSettings()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- äºˆå®šè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="detail-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;" id="detail-title">ã‚¿ã‚¤ãƒˆãƒ«</h3>
      <p id="detail-info" style="font-size:0.9em; color:#555; white-space:pre-wrap;"></p>
      <input type="hidden" id="detail-id">
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="closeModal('detail-modal')">é–‰ã˜ã‚‹</button>
        <button class="btn btn-danger" onclick="deleteCurrentEvent()">å‰Šé™¤</button>
      </div>
    </div>
  </div>

  <!-- ã‚»ãƒ«å†…ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="cell-list-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;" id="cell-list-date">æ—¥ä»˜</h3>
      <div id="cell-list-container" class="cell-detail-list"></div>
      <div class="modal-actions"><button class="btn btn-cancel" onclick="closeModal('cell-list-modal')">é–‰ã˜ã‚‹</button></div>
    </div>
  </div>

  <!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="upload-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top:0;">ğŸ“· AIè§£æ</h3>
      <img id="preview-image" style="width:100%; max-height:150px; object-fit:contain; border:1px solid #eee; margin-bottom:10px; border-radius:8px;">
      <div style="font-size:11px; color:#666; margin-bottom:8px; background:#f9f9f9; padding:8px; border-radius:6px;">ğŸ’¡ ãƒ’ãƒ³ãƒˆ: è¤‡é›‘ãªè¡¨ã®å ´åˆã¯ã€Œâ—‹â—‹ã®è¡Œã ã‘ã€ã€Œ11æœˆã®äºˆå®šã€ãªã©å…·ä½“çš„ã«æŒ‡ç¤ºã™ã‚‹ã¨ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™</div>
      <textarea id="prompt-input" style="width:100%; height:60px; border:1px solid #ccc; padding:8px; box-sizing:border-box; border-radius:6px; font-size:14px;" placeholder="ä¾‹: è¥¿æ‘ã®è¡Œã ã‘å–ã‚Šè¾¼ã‚“ã§&#10;ä¾‹: 11æœˆã®å…¬ä¼‘ã¨å‡ºå¼µã ã‘ç™»éŒ²"></textarea>
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="closeModal('upload-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-save" onclick="submitImage()">è§£æã—ã¦ç™»éŒ²</button>
      </div>
    </div>
  </div>

  <!-- ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="chat-modal" class="modal-overlay">
    <div class="modal-content" style="height:65vh;">
      <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:10px;">
        <span>ğŸ’¬ ã‚¹ã‚±åŠ©AI</span><span onclick="closeModal('chat-modal')" style="cursor:pointer;">âœ•</span>
      </div>
      <div id="chat-history" style="flex:1; overflow-y:auto; background:#f9f9f9; padding:10px; border:1px solid #eee; border-radius:6px; margin-bottom:10px;">
        <div style="text-align:left; margin:5px;"><span style="background:#fff; padding:8px; border-radius:8px; display:inline-block; font-size:0.85em; border:1px solid #eee;">ã“ã‚“ã«ã¡ã¯ï¼ã‚¹ã‚±åŠ©ã§ã™ğŸ˜Š<br><br>ğŸ“… <b>äºˆå®šã®è¿½åŠ </b>ï¼šã€Œæ˜æ—¥10æ™‚ã«ä¼šè­°ã‚’ç™»éŒ²ã—ã¦ã€<br>ğŸ” <b>äºˆå®šã®ç¢ºèª</b>ï¼šã€Œä»Šé€±ã®äºˆå®šã¯ï¼Ÿã€<br>ğŸ“ <b>äºˆå®šã®å¤‰æ›´</b>ï¼šã€Œä¼šè­°ã‚’æ¥é€±æœˆæ›œã«å¤‰æ›´ã—ã¦ã€<br>ğŸ—‘ï¸ <b>äºˆå®šã®å‰Šé™¤</b>ï¼šã€Œä¼šè­°ã‚’å‰Šé™¤ã—ã¦ã€<br><br>ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ï¼</span></div>
      </div>
      <div style="display:flex; gap:5px;">
        <input type="text" id="chat-input" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:20px;" placeholder="ä¾‹: æ˜æ—¥15æ™‚ã«æ­¯åŒ»è€…ã‚’ç™»éŒ²ã—ã¦" onkeypress="if(event.key==='Enter')sendChat()">
        <button onclick="sendChat()" style="border:none; background:#4285f4; color:white; border-radius:20px; padding:0 15px; font-size:1.1em;">â¤</button>
      </div>
    </div>
  </div>

  <script>
    function serverCall(func, ...args) {
      return new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)[func](...args);
      });
    }

    let calendar;
    let allEvents = [];
    let userSettings = { 
      name: "ã‚²ã‚¹ãƒˆ", 
      categories: [
        {name:"ä»•äº‹",color:"#4285f4"},
        {name:"ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ",color:"#34a853"}
      ] 
    };
    
    let timelineDates = [];
    let todayIndex = 0;

    document.addEventListener('DOMContentLoaded', async function() {
      loadSettingsLocal();
      applySettingsUI();
      initCalendar();
      updateCategorySelect();
      setupTimelineSync();
      
      showLoading("èª­è¾¼ä¸­...");
      try {
        await Promise.all([loadSettingsFromServer(), loadData(false)]);
        showToast('âœ… ' + allEvents.length + 'ä»¶ã®äºˆå®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
      } catch(e) {
        console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
        showToast('âš ï¸ èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
      hideLoading();
    });

    async function loadData(showNotification = false) {
      try {
        const data = await serverCall('getEvents');
        allEvents = data || [];
        updateCalendar(allEvents);
        updateTimeline(allEvents);
        if (showNotification) showToast('âœ… ' + allEvents.length + 'ä»¶ã®äºˆå®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
      } catch(e) { 
        console.error("loadDataã‚¨ãƒ©ãƒ¼:", e); 
        allEvents = [];
        updateCalendar([]);
        updateTimeline([]);
        if (showNotification) showToast('âŒ èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    function toggleTimeInput() {
      const isAllDay = document.getElementById('inp-allday').checked;
      const type = isAllDay ? 'date' : 'datetime-local';
      document.getElementById('inp-start').type = type;
      document.getElementById('inp-end').type = type;
    }

    function showEventDetail(eventObj) {
      let id = eventObj.id || (eventObj.extendedProps && eventObj.extendedProps.id);
      if (!id) { alert("ã‚¨ãƒ©ãƒ¼: äºˆå®šã®IDãŒå–å¾—ã§ãã¾ã›ã‚“"); return; }
      
      document.getElementById('detail-id').value = id;
      document.getElementById('detail-title').innerText = eventObj.title || "ç„¡é¡Œ";
      
      const d = eventObj.start ? new Date(eventObj.start) : null;
      let dateStr = "";
      if (d) {
        const isAllDay = eventObj.allDay || (eventObj.extendedProps && eventObj.extendedProps.allDay);
        dateStr = isAllDay ? `${d.getMonth()+1}/${d.getDate()} (çµ‚æ—¥)` : `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
      }
      
      const category = (eventObj.extendedProps && eventObj.extendedProps.category) || eventObj.category || "";
      const memo = (eventObj.extendedProps && eventObj.extendedProps.memo) || eventObj.memo || "";
      
      document.getElementById('detail-info').innerText = `ğŸ“… ${dateStr}\nğŸ“ ${category}\nğŸ“ ${memo}`;
      openModal('detail-modal');
    }

    async function deleteCurrentEvent() {
      const id = document.getElementById('detail-id').value;
      if (!id || id === "" || id === "undefined") { alert("å‰Šé™¤å¯¾è±¡ã®IDãŒå–å¾—ã§ãã¾ã›ã‚“"); return; }
      if (!confirm("ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      
      closeModal('detail-modal');
      closeModal('cell-list-modal');
      showLoading("å‰Šé™¤ä¸­...");
      
      try {
        const res = await serverCall('deleteEvent', id);
        if (res && res.status === 'success') {
          await loadData(false);
          hideLoading();
          showToast('ğŸ—‘ï¸ å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        } else {
          hideLoading();
          showToast('âŒ å‰Šé™¤å¤±æ•—: ' + (res ? res.message : "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"), 'error', 3500);
        }
      } catch(e) {
        hideLoading();
        showToast('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error');
      }
    }

    function openImageMenu() { openModal('image-menu-modal'); }
    function selectCamera() { closeModal('image-menu-modal'); document.getElementById('camera-input').click(); }
    function selectGallery() { closeModal('image-menu-modal'); document.getElementById('gallery-input').click(); }
    
    function handleImageSelect(input) {
      if (!input.files || !input.files[0]) return;
      const file = input.files[0];
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const MAX_SIZE = 1024;
          let w = img.width, h = img.height;
          if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } }
          else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
          canvas.width = w; canvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
          selectedFileBase64 = dataUrl.split(',')[1];
          document.getElementById('preview-image').src = dataUrl;
          document.getElementById('prompt-input').value = "";
          openModal('upload-modal');
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
      input.value = '';
    }

    function showCellEvents(dateStr, events) {
      if (events.length === 0) return;
      document.getElementById('cell-list-date').innerText = dateStr;
      const container = document.getElementById('cell-list-container');
      container.innerHTML = "";
      events.forEach(e => {
        const div = document.createElement('div');
        div.className = 'cell-detail-item';
        const timeStr = e.allDay ? "çµ‚æ—¥" : (e.start ? new Date(e.start).toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}) : "");
        div.innerHTML = `<span>${e.title}</span><span style="font-size:0.8em; color:#666;">${timeStr}</span>`;
        div.onclick = () => showEventDetail({ id: e.id, title: e.title, start: e.start, allDay: e.allDay, extendedProps: { category: e.category, memo: e.memo } });
        container.appendChild(div);
      });
      openModal('cell-list-modal');
    }

    function updateTimeline(data) {
      const headerRow = document.getElementById('timeline-header');
      const categoryCol = document.getElementById('timeline-categories');
      const dataArea = document.getElementById('timeline-data');
      headerRow.innerHTML = ""; categoryCol.innerHTML = ""; dataArea.innerHTML = "";

      const today = new Date(); today.setHours(0, 0, 0, 0);
      let min = new Date(today); min.setMonth(min.getMonth() - 6);
      let max = new Date(today); max.setMonth(max.getMonth() + 6);
      
      timelineDates = [];
      for (let d = new Date(min); d <= max; d.setDate(d.getDate() + 1)) timelineDates.push(new Date(d));
      todayIndex = timelineDates.findIndex(d => d.getFullYear() === today.getFullYear() && d.getMonth() === today.getMonth() && d.getDate() === today.getDate());

      timelineDates.forEach((d, i) => {
        const cell = document.createElement('div');
        cell.className = 'date-header-cell';
        if (d.getDay() === 0) cell.classList.add('sunday');
        if (d.getDay() === 6) cell.classList.add('saturday');
        if (d.getFullYear() === today.getFullYear() && d.getMonth() === today.getMonth() && d.getDate() === today.getDate()) cell.classList.add('today');
        const dayNames = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
        cell.innerHTML = `${d.getMonth()+1}/${d.getDate()}<span style="font-size:0.85em;">${dayNames[d.getDay()]}</span>`;
        headerRow.appendChild(cell);
      });

      userSettings.categories.forEach(cat => {
        const label = document.createElement('div');
        label.className = 'category-label-cell';
        label.style.borderLeft = `4px solid ${cat.color}`;
        label.innerText = cat.name;
        categoryCol.appendChild(label);
      });

      const grid = document.createElement('div');
      grid.className = 'timeline-data-grid';
      grid.style.gridTemplateColumns = `repeat(${timelineDates.length}, 48px)`;
      grid.style.gridTemplateRows = `repeat(${userSettings.categories.length}, 29px)`;

      userSettings.categories.forEach((cat, catIdx) => {
        timelineDates.forEach((d, dateIdx) => {
          const cell = document.createElement('div');
          cell.className = 'timeline-cell';
          if (d.getFullYear() === today.getFullYear() && d.getMonth() === today.getMonth() && d.getDate() === today.getDate()) cell.classList.add('today-col');
          
          const dateKey = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
          const dayEvents = data.filter(e => {
            if (!e.start) return false;
            const ed = new Date(e.start);
            return `${ed.getFullYear()}-${ed.getMonth()}-${ed.getDate()}` === dateKey && e.category && e.category.includes(cat.name);
          });

          dayEvents.slice(0, 2).forEach(e => {
            const card = document.createElement('div');
            card.className = `timeline-event-card ${getUrgencyClass(e.start)}`;
            card.style.borderLeftColor = cat.color;
            card.innerText = e.title;
            cell.appendChild(card);
          });
          if (dayEvents.length > 2) {
            const more = document.createElement('div');
            more.style.fontSize = '0.45em'; more.style.color = '#999'; more.style.lineHeight = '1';
            more.innerText = `+${dayEvents.length - 2}`;
            cell.appendChild(more);
          }
          cell.onclick = () => showCellEvents(`${d.getMonth()+1}/${d.getDate()}ï¼ˆ${cat.name}ï¼‰`, dayEvents);
          grid.appendChild(cell);
        });
      });
      dataArea.appendChild(grid);
      scrollTimelineToToday();
    }

    function setupTimelineSync() {
      const headerRow = document.getElementById('timeline-header');
      const categoryCol = document.getElementById('timeline-categories');
      const dataArea = document.getElementById('timeline-data');
      dataArea.addEventListener('scroll', function() {
        headerRow.scrollLeft = this.scrollLeft;
        categoryCol.scrollTop = this.scrollTop;
      }, { passive: true });
    }

    function scrollTimelineToToday() {
      const dataArea = document.getElementById('timeline-data');
      const headerRow = document.getElementById('timeline-header');
      if (todayIndex > 0) {
        const scrollPos = Math.max(0, (todayIndex - 2) * 48);
        setTimeout(() => { dataArea.scrollLeft = scrollPos; headerRow.scrollLeft = scrollPos; }, 50);
      }
    }

    async function sendChat() {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) return;
      
      const hist = document.getElementById('chat-history');
      hist.innerHTML += `<div style="text-align:right; margin:5px;"><span style="background:#e3f2fd; padding:8px; border-radius:8px; display:inline-block; font-size:0.9em;">${escapeHtml(text)}</span></div>`;
      input.value = ""; hist.scrollTop = hist.scrollHeight;
      
      const loadingId = 'chat-loading-' + Date.now();
      hist.innerHTML += `<div id="${loadingId}" style="text-align:left; margin:5px;"><span style="background:#fff; padding:8px; border-radius:8px; display:inline-block; font-size:0.9em; border:1px solid #eee;">ğŸ”„ è€ƒãˆä¸­...</span></div>`;
      hist.scrollTop = hist.scrollHeight;
      
      try {
        const res = await serverCall('processChat', text);
        document.getElementById(loadingId)?.remove();
        
        let content = '', messageStyle = 'background:#fff; border:1px solid #eee;';
        if (res.status === 'success') {
          content = res.answer || 'å‡¦ç†ã—ã¾ã—ãŸ';
          if (res.action === 'add' && res.eventAdded) { messageStyle = 'background:#e8f5e9; border:1px solid #a5d6a7;'; content = 'âœ… ' + content; await loadData(false); showToast('ğŸ“… äºˆå®šã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success'); }
          else if (res.action === 'update' && res.eventUpdated) { messageStyle = 'background:#fff3e0; border:1px solid #ffcc80;'; content = 'ğŸ“ ' + content; await loadData(false); showToast('ğŸ“ äºˆå®šã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success'); }
          else if (res.action === 'delete' && res.eventDeleted) { messageStyle = 'background:#ffebee; border:1px solid #ef9a9a;'; content = 'ğŸ—‘ï¸ ' + content; await loadData(false); showToast('ğŸ—‘ï¸ äºˆå®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success'); }
        } else { content = 'âš ï¸ ã‚¨ãƒ©ãƒ¼: ' + res.answer; messageStyle = 'background:#ffebee; border:1px solid #ef9a9a;'; }
        
        hist.innerHTML += `<div style="text-align:left; margin:5px;"><span style="${messageStyle} padding:8px; border-radius:8px; display:inline-block; font-size:0.9em;">${escapeHtml(content)}</span></div>`;
        hist.scrollTop = hist.scrollHeight;
      } catch(e) { document.getElementById(loadingId)?.remove(); hist.innerHTML += `<div style="text-align:left; margin:5px; color:red;">âš ï¸ é€šä¿¡ã‚¨ãƒ©ãƒ¼</div>`; }
    }
    
    function escapeHtml(text) { return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>'); }

    function initCalendar() {
      const el = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth', locale: 'ja', height: '100%', fixedWeekCount: true, dayMaxEvents: 2,
        headerToolbar: { left: 'title', right: 'customToday prev,next' },
        customButtons: { customToday: { text: 'ä»Šæ—¥', click: function() { calendar.today(); scrollTimelineToToday(); } } },
        dayCellContent: e => ({ html: e.dayNumberText.replace('æ—¥','') }),
        eventClick: info => showEventDetail(info.event),
        eventContent: arg => { const color = getCatColor(arg.event.extendedProps.category); return { html: `<span style="color:${color}; font-size:0.7em;">â—</span><span style="font-size:0.65em;"> ${escapeHtml(arg.event.title)}</span>` }; }
      });
      calendar.render();
    }

    function updateCalendar(data) {
      calendar.removeAllEvents();
      const events = data.map(i => ({ id: i.id, title: i.title, start: i.start, end: i.end, allDay: i.allDay, extendedProps: { category: i.category, memo: i.memo } }));
      calendar.addEventSource(events);
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function showLoading(txt) { document.getElementById('loading-overlay').style.display = 'flex'; document.getElementById('loading-text').innerText = txt; }
    function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }
    
    function showToast(message, type = 'info', duration = 2500) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type; toast.innerText = message;
      container.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, duration);
    }
    
    function openAddModal() {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('inp-title').value = "";
      document.getElementById('inp-start').value = now.toISOString().slice(0,10);
      document.getElementById('inp-end').value = now.toISOString().slice(0,10);
      document.getElementById('inp-memo').value = "";
      document.getElementById('inp-allday').checked = true;
      toggleTimeInput();
      updateCategorySelect();
      openModal('add-modal');
    }

    async function loadSettingsFromServer() {
      try {
        const res = await serverCall('loadUserSettings');
        if (res && res.status === 'success' && res.settings) {
          userSettings = res.settings;
          localStorage.setItem('sukesuke_settings', JSON.stringify(userSettings));
        } else { loadSettingsLocal(); }
      } catch(e) { loadSettingsLocal(); }
      applySettingsUI();
    }
    
    function loadSettingsLocal() {
      const saved = localStorage.getItem('sukesuke_settings');
      if (saved) { try { userSettings = JSON.parse(saved); } catch(e) {} }
    }

    function applySettingsUI() {
      let displayName = userSettings.name || "ã‚²ã‚¹ãƒˆ";
      if (!displayName.endsWith("ã•ã‚“")) displayName = displayName + " ã•ã‚“";
      document.getElementById('user-name-display').textContent = displayName;
      if (allEvents.length > 0) { updateCalendar(allEvents); updateTimeline(allEvents); }
      updateCategorySelect();
    }

    function openSettings() {
      document.getElementById('set-name').value = userSettings.name;
      const list = document.getElementById('cat-setting-list');
      list.innerHTML = "";
      userSettings.categories.forEach(cat => addCatSettingRow(cat.name, cat.color));
      openModal('settings-modal');
    }
    
    function addCatSettingRow(name = "", color = "#555555") {
      const list = document.getElementById('cat-setting-list');
      const div = document.createElement('div'); div.className = 'cat-edit-row';
      
      const colorBox = document.createElement('div');
      colorBox.className = 'cat-color-box';
      colorBox.style.backgroundColor = color || "#555555";
      
      const colorInput = document.createElement('input');
      colorInput.type = 'color'; colorInput.className = 'cat-edit-color';
      colorInput.value = color || "#555555";
      
      colorBox.addEventListener('click', function(e) { e.preventDefault(); colorInput.click(); });
      colorInput.addEventListener('input', function() { colorBox.style.backgroundColor = this.value; });
      colorInput.addEventListener('change', function() { colorBox.style.backgroundColor = this.value; });
      
      const nameInput = document.createElement('input');
      nameInput.type = 'text'; nameInput.className = 'cat-name-input';
      nameInput.value = name || ""; nameInput.placeholder = 'ã‚«ãƒ†ã‚´ãƒªå';
      
      const delBtn = document.createElement('button');
      delBtn.type = 'button'; delBtn.className = 'btn-del-cat'; delBtn.textContent = 'âœ•';
      function handleDelete(e) { e.preventDefault(); e.stopPropagation(); div.remove(); }
      delBtn.addEventListener('click', handleDelete);
      delBtn.addEventListener('touchend', handleDelete);
      
      div.appendChild(colorBox); div.appendChild(colorInput); div.appendChild(nameInput); div.appendChild(delBtn);
      list.appendChild(div);
    }
    
    async function saveSettings() {
      const nameInp = document.getElementById('set-name').value;
      if (nameInp) userSettings.name = nameInp;
      
      const rows = document.querySelectorAll('.cat-edit-row');
      const newCats = [];
      rows.forEach(row => {
        const nameEl = row.querySelector('.cat-name-input');
        const colorEl = row.querySelector('.cat-edit-color');
        const name = nameEl ? nameEl.value.trim() : '';
        const color = colorEl ? colorEl.value : '#555555';
        if (name) newCats.push({ name, color });
      });
      if (newCats.length > 0) userSettings.categories = newCats;
      
      localStorage.setItem('sukesuke_settings', JSON.stringify(userSettings));
      try {
        const res = await serverCall('saveUserSettings', userSettings);
        if (res && res.status === 'success') showToast('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
        else showToast('âš ï¸ ã‚µãƒ¼ãƒãƒ¼ä¿å­˜ã«å¤±æ•—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã«ã¯ä¿å­˜æ¸ˆã¿ï¼‰', 'info');
      } catch(e) { showToast('âš ï¸ ã‚µãƒ¼ãƒãƒ¼ä¿å­˜ã«å¤±æ•—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã«ã¯ä¿å­˜æ¸ˆã¿ï¼‰', 'info'); }
      applySettingsUI();
      closeModal('settings-modal');
    }

    function updateCategorySelect() {
      const sel = document.getElementById('inp-category');
      sel.innerHTML = "";
      userSettings.categories.forEach(cat => { const op = document.createElement('option'); op.value = cat.name; op.text = cat.name; sel.appendChild(op); });
    }
    
    async function submitManual() {
      const title = document.getElementById('inp-title').value.trim();
      const start = document.getElementById('inp-start').value;
      if (!title) { alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      if (!start) { alert("é–‹å§‹æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      
      closeModal('add-modal'); showLoading("ç™»éŒ²ä¸­...");
      const payload = { title: title, category: document.getElementById('inp-category').value, start: start, end: document.getElementById('inp-end').value || start, memo: document.getElementById('inp-memo').value, allDay: document.getElementById('inp-allday').checked };
      
      try {
        const res = await serverCall('saveManualEvent', payload);
        if (res.status === 'success') { await loadData(false); hideLoading(); showToast('âœ… äºˆå®šã‚’ç™»éŒ²ã—ã¾ã—ãŸ', 'success'); }
        else { hideLoading(); showToast('âŒ ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + res.message, 'error', 3500); }
      } catch(e) { hideLoading(); showToast('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼', 'error'); }
    }
    
    let selectedFileBase64 = null;
    
    async function submitImage() {
      if (!selectedFileBase64) { showToast('âŒ ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error'); return; }
      closeModal('upload-modal'); showLoading("ğŸ¤– AIè§£æä¸­...");
      const prompt = document.getElementById('prompt-input').value;
      
      try {
        const res = await serverCall('processImage', selectedFileBase64, 'image/jpeg', prompt);
        await loadData(false); hideLoading();
        if (res.status === 'error') showToast('âŒ ' + res.message, 'error', 4000);
        else showToast('âœ… ' + res.message, 'success', 3000);
      } catch(e) { hideLoading(); showToast('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + e, 'error', 4000); }
      selectedFileBase64 = null;
    }
    
    function getCatColor(c) { const found = userSettings.categories.find(cat => c && c.includes(cat.name)); return found ? found.color : '#999'; }
    function getUrgencyClass(d) { if (!d) return ''; const diff = Math.ceil((new Date(d) - new Date()) / (864e5)); if (diff <= 1) return 'border-gold'; if (diff <= 3) return 'border-red'; if (diff <= 7) return 'border-blue'; if (diff <= 14) return 'border-green'; return ''; }
  </script>
</body>
</html>
